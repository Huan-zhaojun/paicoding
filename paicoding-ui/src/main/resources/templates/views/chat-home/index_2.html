<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<div th:replace="components/layout/header :: head(~{::title}, ~{}, ~{})">
    <title th:text="${global.siteInfo.websiteName}">
        派聪明 | 技术派
    </title>
</div>

<link rel="stylesheet" href="/css/views/chat-home.css"/>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.bootcss.com/stomp.js/2.3.3/stomp.min.js"></script>
<body id="body">
<!-- 导航栏 -->
<div th:replace="components/layout/navbar :: navbar"></div>
<div class="custom-home">
    <div class="chat-wrap">
        <div class="chat-sidebar">
            <div class="chat-list">对话列表</div>
            <div class="chat-settings">设置</div>
        </div>

        <div class="chat-main">
            <div class="window-header">
                <div class="window-header-title">
                    <div class="window-header-main-title home_chat-body-title__5S8w4"
                         th:data-target="${global.isLogin ? '' : '#loginModal'}"
                         th:data-toggle="${global.isLogin ? '' : 'modal'}"
                    >点击登录</div>
                    <div class="window-header-sub-title">与派聪明的 0 条对话</div>
                </div>
            </div>
            <div class="chat-display">
                <div class="chat-message">
                    <div class="message-content" id="chat-content">
                    </div>
                </div>
            </div>

            <div class="chat-input">
                <textarea id="input-field" class="form-control" rows="3" placeholder="你好，我是派聪明，快登录和我对线吧" disabled></textarea>
                <button id="send-btn" disabled>
                    <div class="button_icon-button-icon__qlUH3 no-dark">
                        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="16" height="16" fill="none"><defs><path id="send-white_svg__a" d="M0 0h16v16H0z"></path></defs><g><mask id="send-white_svg__b" fill="#fff"><use xlink:href="#send-white_svg__a"></use></mask><g mask="url(#send-white_svg__b)"><path transform="translate(1.333 2)" d="M0 4.71 6.67 6l1.67 6.67L12.67 0 0 4.71Z" style="stroke: rgb(255, 255, 255); stroke-width: 1.33333; stroke-opacity: 1; stroke-dasharray: 0, 0;"></path><path transform="translate(8.003 6.117)" d="M0 1.89 1.89 0" style="stroke: rgb(255, 255, 255); stroke-width: 1.33333; stroke-opacity: 1; stroke-dasharray: 0, 0;"></path></g></g></svg>
                    </div>
                    <div class="button_icon-button-text__k3vob">等待登录</div>
                </button>
            </div>
        </div>
    </div>
    <!-- 底部信息 -->
    <div th:replace="components/layout/footer :: footer"></div>
</div>
</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.5/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script th:inline="javascript">
    const inputField = $("#input-field");
    const sendBtn = $("#send-btn"), sendBtnText = $(".button_icon-button-text__k3vob");
    const chatContent = $("#chat-content");
    // 用户名
    const chatTitle = $(".window-header-main-title");

    // 从 global.user.photo 中取出用户头像 thymeleaf 传入的值
    const isLogin = [[${global.isLogin}]], user = [[${global.user}]];

    // 页面加载完成后，执行 initWs
    $(function () {
        if (isLogin) {
            initWs();
        } else {
            console.log("请先登录");
        }
    });

    var stompClient = null;
    function initWs() {
        var socket = new SockJS('/gpt/' + user.userId);
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('ws连接成功: ' + frame);
            inputField.removeAttr("disabled");
            // 改变 inputField 的 placeholder
            inputField.attr("placeholder", "可按回车发送");
            sendBtnText.text("发送");
            sendBtn.removeAttr("disabled");
            // 改变 chatTitle 的内容
            chatTitle.text(user.userName);


            stompClient.subscribe('/user/chat/rsp', function (message) {
                // 表示这个长连接，订阅了 "/chat/rsp" , 这样后端像这个路径转发消息时，我们就可以拿到对应的返回
                // 解析 JSON 字符串
                const data = JSON.parse(message.data);
                const msg = data.message;
                // type 转为 number 类型
                const type = Number(data.type);

                // 打印到控制台
                console.log("接受消息: " + msg);
                console.log("接收时间: " + data.time);
                console.log("接收类型: " + data.type);

                if (type === 1) {
                    // 把 home_chat-message-actions__loading 的元素移除，不再显示 loading
                    $(".home_chat-message-actions__loading").remove();

                    appendServerMessage(msg, data.time);
                } else if (type === 0) {
                    console.log("连接成功")
                    appendServerMessage(msg, data.time);
                }

                // 添加完消息后，恢复按钮的状态
                sendBtn.removeAttr("disabled");
            });
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        console.log("ws中断");
        stompClient = null;
        // 提醒用户重新连接
        inputField.attr("disabled", "disabled").val("连接中断，点击右侧按钮重连");
        sendBtn.removeAttr("disabled");
        sendBtnText.text("重连");
    }


    // 添加服务器端消息
    function appendServerMessage(content, time) {
        let serverMsg = `
            <div class="home_chat-message__rdH_g">
                <div class="home_chat-message-container__plj_e">
                    <div class="home_chat-message-avatar__611lI">
                        <div class="no-dark">
                            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35" fill="none">
                                <defs><path id="bot_svg__a" d="M0 0h30v30H0z"></path><path id="bot_svg__c" d="M0 0h20.455v20.455H0z"></path></defs><g><rect fill="var(--pai-bg-normal-1)" width="30" height="30" rx="10"></rect><mask id="bot_svg__b" fill="#fff"><use xlink:href="#bot_svg__a"></use></mask><g mask="url(#bot_svg__b)"><g transform="translate(4.773 4.773)"><mask id="bot_svg__d" fill="#fff"><use xlink:href="#bot_svg__c"></use></mask><g mask="url(#bot_svg__d)"><path fill-rule="evenodd" d="M19.11 8.37c.17-.52.26-1.06.26-1.61 0-.9-.24-1.79-.71-2.57a5.24 5.24 0 0 0-4.53-2.59c-.37 0-.73.04-1.09.11A5.201 5.201 0 0 0 9.17 0h-.04C6.86 0 4.86 1.44 4.16 3.57A5.11 5.11 0 0 0 .71 6.04C.24 6.83 0 7.72 0 8.63c0 1.27.48 2.51 1.35 3.45-.18.52-.27 1.07-.27 1.61 0 .91.25 1.8.71 2.58 1.13 1.94 3.41 2.94 5.63 2.47a5.18 5.18 0 0 0 3.86 1.71h.05c2.26 0 4.27-1.44 4.97-3.57a5.132 5.132 0 0 0 3.45-2.47c.46-.78.7-1.67.7-2.58 0-1.28-.48-2.51-1.34-3.46ZM8.947 18.158c-.04.03-.08.05-.12.07.7.58 1.57.89 2.48.89h.01c2.14 0 3.88-1.72 3.88-3.83v-4.76c0-.02-.02-.04-.04-.05l-1.74-.99v5.75c0 .23-.13.45-.34.57l-4.13 2.35Zm-.67-1.153 4.17-2.38c.02-.01.03-.03.03-.05v-1.99l-5.04 2.87c-.21.12-.47.12-.68 0l-4.13-2.35c-.04-.02-.09-.06-.12-.07-.04.21-.06.43-.06.65 0 .67.18 1.33.52 1.92v-.01c.7 1.19 1.98 1.92 3.37 1.92.68 0 1.35-.18 1.94-.51ZM3.903 5.168v-.14c-.85.31-1.57.9-2.02 1.68a3.78 3.78 0 0 0-.52 1.91c0 1.37.74 2.64 1.94 3.33l4.17 2.37c.02.01.04.01.06 0l1.75-1-5.04-2.87a.64.64 0 0 1-.34-.57v-4.71Zm13.253 3.337-4.18-2.38c-.02 0-.04 0-.06.01l-1.74.99 5.04 2.87c.21.12.34.34.34.58v4.85c1.52-.56 2.54-1.99 2.54-3.6 0-1.37-.74-2.63-1.94-3.32ZM8.014 5.83c-.02.01-.03.03-.03.05v1.99L13.024 5a.692.692 0 0 1 .68 0l4.13 2.35c.04.02.08.05.12.07.03-.21.05-.43.05-.65 0-2.11-1.74-3.83-3.88-3.83-.68 0-1.35.18-1.94.51l-4.17 2.38Zm1.133-4.492c-2.15 0-3.89 1.72-3.89 3.83v4.76c0 .02.02.03.03.04l1.75 1v-5.75c0-.23.13-.45.34-.57l4.13-2.35c.04-.03.09-.06.12-.07-.7-.58-1.58-.89-2.48-.89ZM7.983 11.51l2.24 1.27 2.25-1.27V8.95l-2.25-1.28-2.24 1.28v2.56Z" style="fill: var(--pai-brand-1-normal);"></path></g></g></g></g>
                            </svg>
                        </div>
                    </div>
                    <div class="home_chat-message-item__hDEOq">
                        <div class="home_chat-message-top-actions__PfOzb">
                            <div class="home_chat-message-top-action__wXKmA">复制</div>
                        </div>
                        <div class="markdown-body" style="font-size: 14px; height: auto;">
                            <p>${content}</p>
                        </div>
                    </div>
                    <div class="home_chat-message-actions__nrHd1">
                        <div class="home_chat-message-action-date__6ToUp">${time}</div>
                    </div>
                </div>
            </div>
            `;

        chatContent.append(serverMsg);

        // 添加完后滚动到底部
        scrollToBottom();

        copy();
    }


    // 复制功能
    function copy() {
        // 从 chatContent 中获取最后一个 chat-message
        const chatMessage = chatContent.children(".home_chat-message__rdH_g").last();
        console.log("chatContent", chatMessage);
        // 从 chatMessage 找出复制按钮
        const copyBtn = chatMessage.find(".home_chat-message-top-action__wXKmA").get(0);

        const clipboard = new ClipboardJS(copyBtn, {
            text: function(trigger) {
                let copyInput = chatMessage.find('.markdown-body').get(0);
                return copyInput.innerText;
            }
        });

        clipboard.on('success', function(e) {
            // 复制成功
            toastr.info("复制成功");
            e.clearSelection();
        });

        clipboard.on('error', function(e) {
            console.log('复制失败');
        });
    }

    // 添加用户端消息
    function addClientMsg(messageContent) {
        const avatarUrl = user.photo;
        let userMsg = `
            <div class="home_chat-message-user__WsuiB">
                <div class="home_chat-message-container__plj_e">
                    <div class="home_chat-message-avatar__611lI">
                        <div class="user-avatar">
                            <img src="${avatarUrl}" alt="smiley" class="__EmojiPicker__ epr-emoji-img" loading="eager">
                        </div>
                    </div>
                    <div class="home_chat-message-item__hDEOq">
                        <div class="markdown-body" style="font-size: 14px; height: auto;">
                            <p>${messageContent}</p>
                        </div>
                    </div>
                    <div class="home_chat-message-actions__loading">
                        <div class="home_chat-message-action-loading__6ToUp">
                            <div class="lds-ellipsis">
                                <div></div>
                                <div></div>
                                <div></div>
                                <div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            `;


        chatContent.append(userMsg);
        // 添加完后滚动到底部
        scrollToBottom();
    }

    // 滚动到底部
    function scrollToBottom() {
        $(".chat-display").scrollTop(chatContent[0].scrollHeight);
    }

    function doSend() {
        const qa = inputField.val();
        // 表示讲消息转发到那个目标，类似与http请求中的path路径
        stompClient.send("/chat/" + user.userId, {'s-uid': user.userId}, qa);
        // 清空 textarea
        inputField.val("");

        addClientMsg(qa);

        // 将 button 设为禁用，防止用户连续点击
        sendBtn.attr("disabled", true);
    }


    sendBtn.click(function () {
        if (stompClient == null) {
            initWs();
        } else {
            // 如果消息内容为空的时候重新聚焦到输入框
            if (inputField.val() === "") {
                inputField.focus();
            } else {
                // 发送消息
                doSend();
            }
        }
    });

    inputField.keydown(function (e) {
        if (e.keyCode === 13) {
            // 按下回车的时候调用 sendbtn 的 click 事件
            sendBtn.click();
            // 阻止默认行为
            e.preventDefault();
        }
    });
</script>
</html>
